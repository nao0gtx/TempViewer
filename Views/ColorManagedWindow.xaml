<Window
    x:Class="TransparentWinUI3.Views.ColorManagedWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:TransparentWinUI3.Controls"
    mc:Ignorable="d"
    Title="色彩管理预览 (实验性)">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="300"/>
        </Grid.ColumnDefinitions>

        <!-- Image Area -->
        <Grid Grid.Column="0" Background="#202020">
            <controls:ColorManagedImageControl x:Name="ImageControl"/>
        </Grid>

        <!-- Controls Area -->
        <ScrollViewer Grid.Column="1" Background="#303030" VerticalScrollBarVisibility="Auto">
            <StackPanel Padding="12" Spacing="12">
                <TextBlock Text="色彩管理设置" FontSize="20" FontWeight="Bold" Margin="0,0,0,12"/>

                <TextBlock Text="当前显示器 ICC:" FontWeight="SemiBold"/>
                <TextBlock x:Name="MonitorProfileText" Text="Detecting..." TextWrapping="Wrap" Foreground="#AAAAAA"/>

                <TextBlock Text="源色彩空间 (Source Context):" FontWeight="SemiBold" Margin="0,12,0,0"/>
                <TextBlock x:Name="DetectedSourceProfileText" Text="未检测到嵌入配置" FontSize="12" Foreground="#AAAAAA" TextWrapping="Wrap" Margin="0,2,0,0"/>
                <ComboBox x:Name="SourceSpaceCombo" SelectedIndex="0" SelectionChanged="UpdateAllCMConfigs" HorizontalAlignment="Stretch" Margin="0,5,0,0">
                    <ComboBoxItem Content="sRGB (Standard)"/>
                    <ComboBoxItem Content="Adobe RGB (1998)"/>
                    <ComboBoxItem Content="Display P3"/>
                    <ComboBoxItem Content="ProPhoto RGB"/>
                    <ComboBoxItem Content="Custom (ICC)..."/>
                    <ComboBoxItem Content="[TEST] Visual Pipe Test (Red Tint)"/>
                    <ComboBoxItem Content="[TEST] Force Gamma Shift (Math Test)"/>
                </ComboBox>
                <Button x:Name="LoadSourceProfileBtn" Content="加载自定义源配置..." Click="LoadSourceProfileBtn_Click" HorizontalAlignment="Stretch" Visibility="Collapsed"/>

                <ToggleSwitch x:Name="EnableCMToggle" Header="启用色彩管理" IsOn="True" Toggled="EnableCMToggle_Toggled" Margin="0,12,0,0"/>

                <Expander x:Name="HdrDebugExpander" Header="HDR 调试与增强 (HDR Debug &amp; Enhance)" HorizontalAlignment="Stretch" Margin="0,5,0,0" Visibility="Collapsed">
                    <StackPanel Spacing="12" Margin="0,10,0,0">
                        <CheckBox x:Name="StrictDebugModeCheck" Content="Strict Debug Mode (Rec.2020 SDR)" Checked="StrictDebugCheck_Changed" Unchecked="StrictDebugCheck_Changed"/>
                        
                        <StackPanel x:Name="HdrIntensityPanel" Visibility="Collapsed" Spacing="4">
                            <TextBlock Text="HDR 亮度增强 (Expansion):" FontWeight="SemiBold"/>
                            <Slider x:Name="HdrIntensitySlider" Minimum="1.0" Maximum="10.0" Value="1.0" StepFrequency="0.1" ValueChanged="HdrIntensitySlider_ValueChanged" HorizontalAlignment="Stretch"/>
                            <TextBlock x:Name="HdrIntensityValueText" Text="1.0x" HorizontalAlignment="Right" FontSize="11" Foreground="#808080"/>
                            <TextBlock Text="用于增强 SDR 容器中的 HDR (如 AVIF Gain Maps)" FontSize="10" Foreground="#808080" FontStyle="Italic" TextWrapping="Wrap"/>
                            <CheckBox x:Name="ForceLinearCheckbox" Content="强制 Gamma 线性化 (修复发灰)" IsChecked="True" Checked="ForceLinearCheckbox_Toggled" Unchecked="ForceLinearCheckbox_Toggled"/>
                            <CheckBox x:Name="LimitedRangeCheckbox" Content="Limited Range (16-235 -> 0-255)" IsChecked="False" Checked="LimitedRangeCheckbox_Toggled" Unchecked="LimitedRangeCheckbox_Toggled"/>
                            
                            <TextBlock Text="输入曲线 (Input Curve):" Margin="0,8,0,2" FontSize="12" Foreground="Gray"/>
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <RadioButton x:Name="CurveGammaRadio" Content="Gamma 2.2" IsChecked="True" Checked="CurveOption_Checked" FontSize="12"/>
                                <RadioButton x:Name="CurvePqRadio" Content="PQ (ST.2084)" Checked="CurveOption_Checked" FontSize="12"/>
                            </StackPanel>

                            <StackPanel x:Name="PqControlsPanel" Visibility="Collapsed" Margin="0,5,0,0">
                                <TextBlock Text="PQ 峰值亮度 (Peak Nits):" FontSize="11" Foreground="#808080"/>
                                <Slider x:Name="PqNitsSlider" Minimum="80" Maximum="10000" Value="10000" StepFrequency="10" ValueChanged="PqNitsSlider_ValueChanged" HorizontalAlignment="Stretch"/>
                                <TextBlock x:Name="PqNitsValueText" Text="10000 nits" HorizontalAlignment="Right" FontSize="11" Foreground="#808080"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Expander>

                <TextBlock Text="渲染意图:" FontWeight="SemiBold" Margin="0,12,0,0"/>
                <ComboBox x:Name="RenderingIntentCombo" SelectedIndex="0" SelectionChanged="RenderingIntentCombo_SelectionChanged" HorizontalAlignment="Stretch">
                    <ComboBoxItem Content="Perceptual (感知)"/>
                    <ComboBoxItem Content="Relative Colorimetric (相对比色)"/>
                    <ComboBoxItem Content="Saturation (饱和度)"/>
                    <ComboBoxItem Content="Absolute Colorimetric (绝对比色)"/>
                </ComboBox>

                <TextBlock Text="目标色彩空间 (Target Profile):" FontWeight="SemiBold" Margin="0,12,0,0"/>
                <ComboBox x:Name="TargetSpaceCombo" SelectedIndex="0" SelectionChanged="UpdateAllCMConfigs" HorizontalAlignment="Stretch">
                    <ComboBoxItem Content="自动检测 (Monitor Default)"/>
                    <ComboBoxItem Content="sRGB (Standard)"/>
                    <ComboBoxItem Content="Adobe RGB (1998)"/>
                    <ComboBoxItem Content="Display P3"/>
                    <ComboBoxItem Content="ProPhoto RGB"/>
                    <ComboBoxItem Content="Custom (ICC)..."/>
                </ComboBox>
                <Button x:Name="LoadTargetProfileBtn" Content="加载自定义目标配置..." Click="LoadProfileBtn_Click" HorizontalAlignment="Stretch" Visibility="Collapsed" Margin="0,5,0,0"/>

                <Button x:Name="RefreshMonitorBtn" Content="刷新显示器配置" Click="RefreshMonitorBtn_Click" HorizontalAlignment="Stretch" Margin="0,12,0,0"/>

                <TextBlock Text="色彩管线状态:" FontWeight="SemiBold" Margin="0,24,0,0"/>
                <StackPanel Margin="0,5,0,0" Spacing="2">
                    <TextBlock x:Name="HdrStatusText" Text="显示器 HDR: Off" FontSize="12" FontWeight="Bold"/>
                    <Button x:Name="OpenHdrSettingsBtn" Content="打开系统 HDR 设置" Click="OpenHdrSettingsBtn_Click" 
                            FontSize="11" Padding="8,2" Margin="0,2,0,5" HorizontalAlignment="Left" Visibility="Collapsed"/>
                    <TextBlock x:Name="ImageHdrText" Text="图像 HDR: SDR" FontSize="12"/>
                    <TextBlock x:Name="MappingModeText" Text="映射模式: SDR -> SDR" FontSize="12" Foreground="#808080"/>
                </StackPanel>
                
                <TextBlock x:Name="DebugInfoText" Text="Ready" TextWrapping="Wrap" FontSize="12" Foreground="#808080" Margin="0,10,0,0"/>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Window>
